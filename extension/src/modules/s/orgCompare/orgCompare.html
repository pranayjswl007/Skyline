<!--
 Copyright 2025 Mitch Spano

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<template>
  <div class="org-compare-container">
    <!-- Header Section -->
    <div class="header-section">
      <h1 class="page-title">
        <lightning-icon icon-name="utility:compare" size="medium" class="slds-m-right_medium"></lightning-icon>
        Org Compare & Deploy
      </h1>
      <p class="page-description">Compare metadata between Salesforce orgs and create deployment packages</p>
    </div>

    <!-- Configuration Section -->
    <div class="config-section">
      <div class="config-grid">
        <!-- Source Configuration -->
        <div class="config-card">
          <h3 class="config-title">Source</h3>
          <div class="config-content">
            <div class="source-type-selector">
              <label class="slds-radio">
                <input type="radio" name="sourceType" value="org" onchange={handleSourceTypeChange} />
                <span class="slds-radio_faux"></span>
                <span class="slds-form-element__label">Salesforce Org</span>
              </label>
              <label class="slds-radio">
                <input type="radio" name="sourceType" value="git" onchange={handleSourceTypeChange} />
                <span class="slds-radio_faux"></span>
                <span class="slds-form-element__label">Git Repository</span>
              </label>
            </div>
            
            <template lwc:if={isSourceOrg}>
              <div class="org-selector">
                <label class="slds-form-element__label">Select Source Org</label>
                <div class="slds-select_container">
                  <select class="slds-select" onchange={handleSourceOrgChange}>
                    <option value="">Select an org</option>
                    <template for:each={sourceOrgs} for:item="org">
                      <option key={org.alias} value={org.alias}>{org.alias}</option>
                    </template>
                  </select>
                </div>
              </div>
            </template>
            
            <template lwc:if={isSourceGit}>
              <div class="git-selector">
                <label class="slds-form-element__label">Git Branch</label>
                <div class="slds-select_container">
                  <select class="slds-select" onchange={handleSourceBranchChange}>
                    <option value="">Select a branch</option>
                    <template for:each={sourceBranches} for:item="branch">
                      <option key={branch} value={branch}>{branch}</option>
                    </template>
                  </select>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Target Configuration -->
        <div class="config-card">
          <h3 class="config-title">Target</h3>
          <div class="config-content">
            <div class="target-type-selector">
              <label class="slds-radio">
                <input type="radio" name="targetType" value="org" onchange={handleTargetTypeChange} />
                <span class="slds-radio_faux"></span>
                <span class="slds-form-element__label">Salesforce Org</span>
              </label>
              <label class="slds-radio">
                <input type="radio" name="targetType" value="git" onchange={handleTargetTypeChange} />
                <span class="slds-radio_faux"></span>
                <span class="slds-form-element__label">Git Repository</span>
              </label>
            </div>
            
            <template lwc:if={isTargetOrg}>
              <div class="org-selector">
                <label class="slds-form-element__label">Select Target Org</label>
                <div class="slds-select_container">
                  <select class="slds-select" onchange={handleTargetOrgChange}>
                    <option value="">Select an org</option>
                    <template for:each={targetOrgs} for:item="org">
                      <option key={org.alias} value={org.alias}>{org.alias}</option>
                    </template>
                  </select>
                </div>
              </div>
            </template>
            
            <template lwc:if={isTargetGit}>
              <div class="git-selector">
                <label class="slds-form-element__label">Git Branch</label>
                <div class="slds-select_container">
                  <select class="slds-select" onchange={handleTargetBranchChange}>
                    <option value="">Select a branch</option>
                    <template for:each={targetBranches} for:item="branch">
                      <option key={branch} value={branch}>{branch}</option>
                    </template>
                  </select>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="compare-button" onclick={handleCompareClick}>
          <lightning-icon icon-name="utility:compare" size="small" class="slds-m-right_small"></lightning-icon>
          Compare
        </button>
      </div>
    </div>

    <!-- Progress Indicator -->
    <template lwc:if={isComparing}>
      <div class="progress-container">
        <div class="slds-card">
          <div class="slds-card__body slds-card__body_inner">
            <div class="slds-text-align_center">
              <div class="slds-spinner slds-spinner_medium slds-spinner_brand" role="status">
                <span class="slds-assistive-text">Loading</span>
                <div class="slds-spinner__dot-a"></div>
                <div class="slds-spinner__dot-b"></div>
              </div>
              <div class="slds-m-top_medium">
                <p class="slds-text-body_regular">Retrieving metadata from both orgs...</p>
                
                <!-- Source Progress -->
                <div class="progress-section">
                  <h4>Source Org Progress</h4>
                  <div class="slds-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                    <span class="slds-progress-bar__value"></span>
                  </div>
                  <p class="slds-text-body_small slds-text-color_weak">
                    Downloading metadata types...
                  </p>
                </div>
                
                <!-- Target Progress -->
                <div class="progress-section">
                  <h4>Target Org Progress</h4>
                  <div class="slds-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                    <span class="slds-progress-bar__value"></span>
                  </div>
                  <p class="slds-text-body_small slds-text-color_weak">
                    Downloading metadata types...
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>

    <!-- Results Section -->
    <template lwc:if={comparisonResult}>
      <div class="results-section">
        <!-- Summary Cards -->
        <div class="results-summary">
          <div class="summary-card added">
            <div class="summary-icon">
              <lightning-icon icon-name="utility:add" size="medium"></lightning-icon>
            </div>
            <div class="summary-content">
              <div class="summary-count">{comparisonResult.added.length}</div>
              <div class="summary-label">Added</div>
            </div>
          </div>
          
          <div class="summary-card removed">
            <div class="summary-icon">
              <lightning-icon icon-name="utility:delete" size="medium"></lightning-icon>
            </div>
            <div class="summary-content">
              <div class="summary-count">{comparisonResult.removed.length}</div>
              <div class="summary-label">Removed</div>
            </div>
          </div>
          
          <div class="summary-card changed">
            <div class="summary-icon">
              <lightning-icon icon-name="utility:edit" size="medium"></lightning-icon>
            </div>
            <div class="summary-content">
              <div class="summary-count">{comparisonResult.changed.length}</div>
              <div class="summary-label">Changed</div>
            </div>
          </div>
          
          <div class="summary-card unchanged">
            <div class="summary-icon">
              <lightning-icon icon-name="utility:check" size="medium"></lightning-icon>
            </div>
            <div class="summary-content">
              <div class="summary-count">{comparisonResult.unchanged.length}</div>
              <div class="summary-label">Unchanged</div>
            </div>
          </div>
        </div>

        <!-- Filter Buttons -->
        <div class="filter-buttons">
          <button class="filter-button active" onclick={handleFilterAll}>All</button>
          <button class="filter-button" onclick={handleFilterAdded}>Added</button>
          <button class="filter-button" onclick={handleFilterRemoved}>Removed</button>
          <button class="filter-button" onclick={handleFilterChanged}>Changed</button>
          <button class="filter-button" onclick={handleFilterUnchanged}>Unchanged</button>
        </div>

        <!-- Results Table -->
        <div class="results-table-container">
          <div class="table-header">
            <div class="selection-controls">
              <label class="slds-checkbox">
                <input type="checkbox" onchange={handleSelectAll} />
                <span class="slds-checkbox_faux"></span>
                <span class="slds-form-element__label">Select All</span>
              </label>
              <span class="selected-count">Selected items</span>
            </div>
            <button class="next-button" onclick={handleCreatePackage}>
              <lightning-icon icon-name="utility:forward" size="small" class="slds-m-right_small"></lightning-icon>
              Next - Create Package
            </button>
          </div>
          
          <div class="results-table">
            <div class="table-header-row">
              <div class="table-cell header">Select</div>
              <div class="table-cell header">Status</div>
              <div class="table-cell header">Type</div>
              <div class="table-cell header">Name</div>
              <div class="table-cell header">Last Modified</div>
              <div class="table-cell header">Actions</div>
            </div>
            
            <template for:each={filteredComparisonResult} for:item="item" for:index="index">
              <div key={item.fullName} class="table-row">
                <div class="table-cell">
                  <label class="slds-checkbox">
                    <input type="checkbox" onchange={handleItemSelect} data-item="item" />
                    <span class="slds-checkbox_faux"></span>
                  </label>
                </div>
                <div class="table-cell">
                  <span class="status-badge">Status</span>
                </div>
                <div class="table-cell">Type</div>
                <div class="table-cell">Name</div>
                <div class="table-cell">Last Modified</div>
                <div class="table-cell">
                  <button class="view-diff-button" onclick={handleViewDiff} data-item="item">
                    View Diff
                  </button>
                </div>
              </div>
            </template>
            
            <!-- Diff Viewer Component -->
            <template lwc:if={showDiffViewer}>
              <s-diff-viewer 
                source-label={sourceDiffLabel}
                target-label={targetDiffLabel}
                diff-content={diffViewerContent}
                show-line-numbers="true"
                show-syntax-highlighting="true"
                onclose={handleCloseDiffViewer}>
              </s-diff-viewer>
            </template>
          </div>
        </div>
      </div>
    </template>
  </div>
</template> 