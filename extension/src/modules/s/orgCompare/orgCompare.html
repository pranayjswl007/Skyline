<!--
 Copyright 2025 Mitch Spano

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->

<template>
  <div class="slds-p-around_medium">
    <!-- Error Display -->
    <template lwc:if={error}>
      <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_error" role="alert">
        <span class="slds-assistive-text">error</span>
        <lightning-icon icon-name="utility:error" alternative-text="Error" size="x-small" class="slds-m-right_x-small"></lightning-icon>
        <h2>{error}</h2>
      </div>
    </template>

    <!-- Spinner -->
    <template lwc:if={spinnerDisplayText.length}>
      <div class="slds-spinner_container">
        <div role="status" class="slds-spinner slds-spinner_medium slds-spinner_brand">
          <span class="slds-assistive-text">Loading</span>
          <div class="slds-spinner__dot-a"></div>
          <div class="slds-spinner__dot-b"></div>
        </div>
      </div>
      <div class="slds-text-align_center slds-m-top_medium">
        <template for:each={spinnerDisplayText} for:item="message">
          <div key={message} class="slds-text-body_small">{message}</div>
        </template>
      </div>
    </template>

    <!-- Git Repo Info -->
    <template lwc:if={isInGitRepo}>
      <div class="slds-notify slds-notify_alert slds-theme_alert-texture slds-theme_info" role="alert">
        <span class="slds-assistive-text">info</span>
        <lightning-icon icon-name="utility:info" alternative-text="Info" size="x-small" class="slds-m-right_x-small"></lightning-icon>
        <h2>Git Repository Detected - Current Branch: {currentBranch}</h2>
      </div>
    </template>

    <!-- Configuration Section -->
    <div class="slds-grid slds-wrap slds-gutters">
      <!-- Source Configuration -->
      <div class="slds-col slds-size_1-of-2">
        <div class="slds-card">
          <div class="slds-card__header">
            <h2 class="slds-card__header-title">
              <span class="slds-card__header-link">
                <span class="slds-text-heading_small">Source</span>
              </span>
            </h2>
          </div>
          <div class="slds-card__body slds-card__body_inner">
            <div class="slds-form">
              <div class="slds-form-element">
                <label class="slds-form-element__label" for="source-type">Type</label>
                <div class="slds-form-element__control">
                  <div class="slds-select_container">
                    <select class="slds-select" id="source-type" onchange={handleSourceTypeChange}>
                      <option value="org">Salesforce Org</option>
                      <option value="git">Git Repository</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Org Configuration -->
              <template lwc:if={isSourceOrg}>
                <div class="slds-form-element slds-m-top_medium">
                  <label class="slds-form-element__label" for="source-org">Org</label>
                  <div class="slds-form-element__control">
                    <div class="slds-select_container">
                      <select class="slds-select" id="source-org" onchange={handleSourceOrgChange}>
                        <option value="">Select an org</option>
                        <template for:each={sourceOrgOptions} for:item="org">
                          <option key={org.value} value={org.value}>{org.label}</option>
                        </template>
                      </select>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Git Configuration -->
              <template lwc:if={isSourceGit}>
                <div class="slds-form-element slds-m-top_medium">
                  <label class="slds-form-element__label" for="source-git-branch">Branch</label>
                  <div class="slds-form-element__control">
                    <div class="slds-select_container">
                      <select class="slds-select" id="source-git-branch" onchange={handleSourceGitBranchChange}>
                        <option value="">Select a branch</option>
                        <template for:each={availableBranches} for:item="branch">
                          <option key={branch} value={branch}>{branch}</option>
                        </template>
                      </select>
                    </div>
                  </div>
                </div>

              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- Target Configuration -->
      <div class="slds-col slds-size_1-of-2">
        <div class="slds-card">
          <div class="slds-card__header">
            <h2 class="slds-card__header-title">
              <span class="slds-card__header-link">
                <span class="slds-text-heading_small">Target</span>
              </span>
            </h2>
          </div>
          <div class="slds-card__body slds-card__body_inner">
            <div class="slds-form">
              <div class="slds-form-element">
                <label class="slds-form-element__label" for="target-type">Type</label>
                <div class="slds-form-element__control">
                  <div class="slds-select_container">
                    <select class="slds-select" id="target-type" onchange={handleTargetTypeChange}>
                      <option value="org">Salesforce Org</option>
                      <option value="git">Git Repository</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Org Configuration -->
              <template lwc:if={isTargetOrg}>
                <div class="slds-form-element slds-m-top_medium">
                  <label class="slds-form-element__label" for="target-org">Org</label>
                  <div class="slds-form-element__control">
                    <div class="slds-select_container">
                      <select class="slds-select" id="target-org" onchange={handleTargetOrgChange}>
                        <option value="">Select an org</option>
                        <template for:each={targetOrgOptions} for:item="org">
                          <option key={org.value} value={org.value}>{org.label}</option>
                        </template>
                      </select>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Git Configuration -->
              <template lwc:if={isTargetGit}>
                <div class="slds-form-element slds-m-top_medium">
                  <label class="slds-form-element__label" for="target-git-branch">Branch</label>
                  <div class="slds-form-element__control">
                    <div class="slds-select_container">
                      <select class="slds-select" id="target-git-branch" onchange={handleTargetGitBranchChange}>
                        <option value="">Select a branch</option>
                        <template for:each={availableBranches} for:item="branch">
                          <option key={branch} value={branch}>{branch}</option>
                        </template>
                      </select>
                    </div>
                  </div>
                </div>

              </template>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="slds-m-top_medium slds-text-align_center">
      <button class="slds-button slds-button_brand" onclick={handleCompareClick} disabled={canCompareDisabled}>
        <lightning-icon icon-name="utility:compare" size="x-small" class="slds-m-right_x-small"></lightning-icon>
        Compare
      </button>
      <button class="slds-button slds-button_success slds-m-left_small" onclick={handleDeployClick} disabled={canDeployDisabled}>
        <lightning-icon icon-name="utility:upload" size="x-small" class="slds-m-right_x-small"></lightning-icon>
        Deploy
      </button>
    </div>

    <!-- Progress Indicator -->
    <template lwc:if={isComparing}>
      <div class="slds-card slds-m-top_medium">
        <div class="slds-card__body slds-card__body_inner">
          <div class="slds-text-align_center">
            <div class="slds-spinner slds-spinner_medium slds-spinner_brand" role="status">
              <span class="slds-assistive-text">Loading</span>
              <div class="slds-spinner__dot-a"></div>
              <div class="slds-spinner__dot-b"></div>
            </div>
            <div class="slds-m-top_medium">
              <p class="slds-text-body_regular">Retrieving metadata from both orgs...</p>
              <p class="slds-text-body_small slds-text-color_weak">
                Source: {sourceCurrentType} ({sourceCompletedTypes}/{sourceTotalTypes}) | 
                Target: {targetCurrentType} ({targetCompletedTypes}/{targetTotalTypes})
              </p>
            </div>
          </div>
        </div>
      </div>
    </template>

    <!-- Filters Section -->
    <template lwc:if={comparisonResult}>
      <div class="slds-card slds-m-top_medium">
        <div class="slds-card__header">
          <h2 class="slds-card__header-title">
            <span class="slds-card__header-link">
              <span class="slds-text-heading_small">Filters</span>
            </span>
          </h2>
        </div>
        <div class="slds-card__body slds-card__body_inner">
          <div class="slds-grid slds-wrap slds-gutters">
            <div class="slds-col slds-size_1-of-3">
              <div class="slds-form-element">
                <label class="slds-form-element__label" for="metadata-type-filter">Metadata Type</label>
                <div class="slds-form-element__control">
                  <div class="slds-select_container">
                    <select class="slds-select" id="metadata-type-filter" multiple onchange={handleMetadataTypeFilterChange}>
                      <template for:each={metadataTypeFilterOptions} for:item="type">
                        <option key={type.value} value={type.value}>{type.label}</option>
                      </template>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="slds-col slds-size_1-of-3">
              <div class="slds-form-element">
                <label class="slds-form-element__label" for="status-filter">Status</label>
                <div class="slds-form-element__control">
                  <div class="slds-select_container">
                    <select class="slds-select" id="status-filter" multiple onchange={handleStatusFilterChange}>
                      <template for:each={statusFilterOptions} for:item="status">
                        <option key={status.value} value={status.value}>{status.label}</option>
                      </template>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="slds-col slds-size_1-of-3">
              <div class="slds-form-element">
                <label class="slds-form-element__label" for="search-term">Search</label>
                <div class="slds-form-element__control">
                  <input type="text" class="slds-input" id="search-term" placeholder="Search metadata..." onchange={handleSearchTermChange} />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>

    <!-- Comparison Results -->
    <template lwc:if={filteredComparisonResult}>
      <div class="slds-card slds-m-top_medium">
        <div class="slds-card__header">
          <h2 class="slds-card__header-title">
            <span class="slds-card__header-link">
              <span class="slds-text-heading_small">Comparison Results</span>
            </span>
          </h2>
        </div>
        <div class="slds-card__body slds-card__body_inner">
          <!-- Quick Filter Buttons -->
          <div class="filter-buttons">
            <button class="filter-button active" onclick={handleFilterAll}>All</button>
            <button class="filter-button" onclick={handleFilterAdded}>Added</button>
            <button class="filter-button" onclick={handleFilterRemoved}>Removed</button>
            <button class="filter-button" onclick={handleFilterChanged}>Changed</button>
            <button class="filter-button" onclick={handleFilterUnchanged}>Unchanged</button>
          </div>

          <!-- Summary -->
          <div class="results-summary">
            <div class="summary-card added">
              <div class="summary-number">{filteredComparisonResult.added.length}</div>
              <div class="summary-label">Added</div>
            </div>
            <div class="summary-card removed">
              <div class="summary-number">{filteredComparisonResult.removed.length}</div>
              <div class="summary-label">Removed</div>
            </div>
            <div class="summary-card changed">
              <div class="summary-number">{filteredComparisonResult.changed.length}</div>
              <div class="summary-label">Changed</div>
            </div>
            <div class="summary-card unchanged">
              <div class="summary-number">{filteredComparisonResult.unchanged.length}</div>
              <div class="summary-label">Unchanged</div>
            </div>
          </div>

          <!-- Results Table -->
          <div class="slds-table_container">
            <table class="slds-table slds-table_cell-buffer slds-table_bordered">
              <thead>
                <tr class="slds-line-height_reset">
                  <th class="slds-text-title_caps" scope="col">
                    <div class="slds-truncate" title="Status">Status</div>
                  </th>
                  <th class="slds-text-title_caps" scope="col">
                    <div class="slds-truncate" title="Type">Type</div>
                  </th>
                  <th class="slds-text-title_caps" scope="col">
                    <div class="slds-truncate" title="Name">Name</div>
                  </th>
                  <th class="slds-text-title_caps" scope="col">
                    <div class="slds-truncate" title="Last Modified">Last Modified</div>
                  </th>
                  <th class="slds-text-title_caps" scope="col">
                    <div class="slds-truncate" title="Actions">Actions</div>
                  </th>
                </tr>
              </thead>
              <tbody>
                <!-- Added Items -->
                <template for:each={filteredComparisonResult.added} for:item="item">
                  <tr key={item.fullName} class="slds-hint-parent">
                    <td>
                      <div class="slds-truncate" title="Added">
                        <lightning-icon icon-name="utility:add" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                        Added
                      </div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.type}>{item.type}</div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.name}>{item.name}</div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.lastModifiedDate}>{item.lastModifiedDate}</div>
                    </td>
                    <td>
                      <button class="slds-button slds-button_neutral slds-button_small" onclick={handleViewDiff} data-item={item.fullName}>
                        View
                      </button>
                    </td>
                  </tr>
                </template>

                <!-- Removed Items -->
                <template for:each={filteredComparisonResult.removed} for:item="item">
                  <tr key={item.fullName} class="slds-hint-parent">
                    <td>
                      <div class="slds-truncate" title="Removed">
                        <lightning-icon icon-name="utility:delete" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                        Removed
                      </div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.type}>{item.type}</div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.name}>{item.name}</div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.lastModifiedDate}>{item.lastModifiedDate}</div>
                    </td>
                    <td>
                      <button class="slds-button slds-button_neutral slds-button_small" onclick={handleViewDiff} data-item={item.fullName}>
                        View
                      </button>
                    </td>
                  </tr>
                </template>

                <!-- Changed Items -->
                <template for:each={filteredComparisonResult.changed} for:item="item">
                  <tr key={item.fullName} class="slds-hint-parent">
                    <td>
                      <div class="slds-truncate" title="Changed">
                        <lightning-icon icon-name="utility:edit" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                        Changed
                      </div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.type}>{item.type}</div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.name}>{item.name}</div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.lastModifiedDate}>{item.lastModifiedDate}</div>
                    </td>
                    <td>
                      <button class="slds-button slds-button_neutral slds-button_small" onclick={handleViewDiff} data-item={item.fullName}>
                        View Diff
                      </button>
                    </td>
                  </tr>
                </template>

                <!-- Unchanged Items -->
                <template for:each={filteredComparisonResult.unchanged} for:item="item">
                  <tr key={item.fullName} class="slds-hint-parent">
                    <td>
                      <div class="slds-truncate" title="Unchanged">
                        <lightning-icon icon-name="utility:check" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                        Unchanged
                      </div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.type}>{item.type}</div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.name}>{item.name}</div>
                    </td>
                    <td>
                      <div class="slds-truncate" title={item.lastModifiedDate}>{item.lastModifiedDate}</div>
                    </td>
                    <td>
                      <button class="slds-button slds-button_neutral slds-button_small" onclick={handleViewDiff} data-item={item.fullName}>
                        View
                      </button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </template>
  </div>
</template> 